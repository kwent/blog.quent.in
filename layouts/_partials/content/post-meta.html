{{/* 文章元信息组件

显示文章标题、发布时间、阅读时间、分类法信息等


@context {page} . 当前文章页面对象
*/}}

{{/* 获取当前页面所属的 series */}}
{{- $currentSeries := .GetTerms "series" }}


<div class="post-meta mb-8">
  <!-- 文章标题 -->
  <h1 class="text-foreground mb-6 text-3xl leading-tight font-bold md:text-4xl">
    {{ .Title }}
  </h1>

  <!-- 文章摘要 -->
  {{ if .Params.summary }}
  <div class="text-muted-foreground mb-6 text-lg leading-relaxed">
    {{ .Params.summary | plainify }}
  </div>
  {{ end }}

  <!-- 元信息区域 -->
  <div class="bg-card border-border rounded-xl border">

    {{/* 如果有 Series，使用 flex 左右分栏布局 */}}
    {{- if $currentSeries }}
    <div class="flex flex-col lg:flex-row">

      {{/* 左侧：文章元信息 */}}
      <div class="flex-shrink-0 lg:w-3/5 p-6 border-b lg:border-b-0 lg:border-r border-border">
        {{- else }}
        {{/* 没有 Series 时，单栏显示 */}}
        <div class="p-6">
          {{- end }}

          <!-- 发布时间和阅读时间 -->
          <div class="text-muted-foreground flex flex-wrap items-center gap-3 text-sm mb-4">
            <!-- 发布时间 -->
            <div class="flex items-center gap-2">
              {{ partial "features/icon.html" (dict "name" "calendar" "size" "sm" "ariaLabel" (i18n
              "post.published_on")) }}
              <time datetime="{{ .Date.Format `2006-01-02` }}">
                {{ dateFormat (i18n "time.date_format" | default "2006年01月02日") .Date }}
              </time>
            </div>

            <!-- 更新时间 -->
            {{ if ne .Date .Lastmod }}
            <div class="flex items-center gap-2">
              {{ partial "features/icon.html" (dict "name" "edit" "size" "sm" "ariaLabel" (i18n "post.updated_on")) }}
              <span>
                {{ i18n "post.updated_on" | default "更新于" }}
                {{ dateFormat (i18n "time.date_format" | default "2006年01月02日") .Lastmod }}
              </span>
            </div>
            {{ end }}

            <!-- 阅读时间 -->
            {{ if .ReadingTime }}
            <div class="flex items-center gap-2">
              {{ partial "features/icon.html" (dict "name" "clock" "size" "sm" "ariaLabel" (i18n "post.reading_time"))
              }}
              <span>{{ .ReadingTime }} {{ if eq .ReadingTime 1 }}{{ i18n "time.minute" | default "minute" }}{{ else }}{{ i18n "time.minutes" | default "minutes" }}{{ end }}</span>
            </div>
            {{ end }}

            <!-- 字数统计 -->
            {{ if .WordCount }}
            <div class="flex items-center gap-2">
              {{ partial "features/icon.html" (dict "name" "text" "size" "sm" "ariaLabel" (i18n "post.words_count")) }}
              <span>{{ .WordCount }} {{ i18n "post.words" | default "字" }}</span>
            </div>
            {{ end }}
          </div>

          <!-- 分类法 -->
          {{- $taxonomies := .Site.Taxonomies }}
          {{- if $taxonomies }}
          <div class="space-y-3 pt-4 border-t border-border">
            {{- range $taxonomyName, $taxonomy := $taxonomies }}
            {{- $terms := $.GetTerms $taxonomyName }}
            {{- if $terms }}
            <div class="flex items-center gap-2">
              <div class="flex-shrink-0">
                {{ partial "features/icon.html" (dict "name" $taxonomyName "size" "sm" "ariaLabel" "") }}
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex flex-wrap items-center gap-1.5">
                  <span class="text-muted-foreground text-sm font-medium">
                    {{ i18n $taxonomyName | default ($taxonomyName | humanize) }}:
                  </span>
                  {{- range $terms }}
                  <a href="{{ .RelPermalink }}"
                    class="inline-flex items-center rounded-full px-2.5 py-1 text-sm font-medium transition-all duration-200 bg-muted/50 text-muted-foreground hover:bg-muted hover:text-foreground">
                    {{ .LinkTitle }}
                  </a>
                  {{- end }}
                </div>
              </div>
            </div>
            {{- end }}
            {{- end }}
          </div>
          {{- end }}

          <!-- 作者信息 -->
          {{ if .Params.author }}
          <div class="flex items-center gap-2 pt-4 border-t border-border mt-4">
            {{ partial "features/icon.html" (dict "name" "user" "size" "sm" "ariaLabel" (i18n "post.author")) }}
            <span class="text-muted-foreground text-sm">
              {{ i18n "post.author" | default "作者" }}:
            </span>
            <span class="text-foreground text-sm font-medium">
              {{ .Params.author }}
            </span>
          </div>
          {{ end }}

          {{- if $currentSeries }}
        </div>

        {{/* 右侧：Series 文章列表 */}}
        <div class="flex-1 lg:w-2/5 flex flex-col" id="series-container">
          <!-- Series 标题栏 (Tabs) -->
          <div class="flex-shrink-0 p-4 border-b border-border">
            <div class="flex items-center gap-2 overflow-x-auto no-scrollbar scroll-smooth" id="series-tabs">
              {{- range $dataIndex, $seriesPage := $currentSeries }}
              {{- $seriesPages := $seriesPage.Pages.ByParam "series_order" }}
              {{- $totalCount := len $seriesPages }}
              {{- $currentIndex := 0 }}
              {{- range $idx, $p := $seriesPages }}
              {{- if eq $p.RelPermalink $.RelPermalink }}
              {{- $currentIndex = add $idx 1 }}
              {{- end }}
              {{- end }}

              <button onclick="switchSeries({{ $dataIndex }})"
                class="series-tab-btn group flex items-center gap-2 px-3 py-2 rounded-lg transition-all border border-transparent {{ if eq $dataIndex 0 }}bg-accent text-foreground border-border shadow-sm{{ else }}hover:bg-accent/50 text-muted-foreground{{ end }}"
                data-index="{{ $dataIndex }}">
                <span class="text-sm font-semibold whitespace-nowrap max-w-[120px] truncate">
                  {{ $seriesPage.LinkTitle }}
                </span>
                <span class="bg-primary/10 text-primary rounded-full px-2 py-0.5 text-[10px] font-bold">
                  {{ $currentIndex }}/{{ $totalCount }}
                </span>
              </button>
              {{- end }}

              <!-- 跳转到分类页的按钮 (仅针对当前激活的 Series，通过 JS 更新 href) -->
              <a href="#" id="series-link-btn"
                class="ml-auto flex-shrink-0 p-2 rounded-lg text-muted-foreground hover:text-primary hover:bg-accent/50 transition-colors"
                title="{{ i18n `post.view_series_archive` | default `查看系列归档` }}">
                {{ partial "features/icon.html" (dict "name" "external-link" "size" "sm") }}
              </a>
            </div>
          </div>

          <!-- Series 内容列表区域 -->
          <div class="flex-1">
            {{- range $dataIndex, $seriesPage := $currentSeries }}
            {{- $seriesPages := $seriesPage.Pages.ByParam "series_order" }}

            <nav id="series-content-{{ $dataIndex }}"
              class="series-content overflow-y-auto max-h-32 p-4 transition-opacity duration-300 {{ if eq $dataIndex 0 }}opacity-100 z-10 block{{ else }}opacity-0 z-0 hidden{{ end }}"
              data-link="{{ $seriesPage.RelPermalink }}">
              <ol class="space-y-1.5">
                {{- range $index, $page := $seriesPages }}
                {{- $isCurrent := eq $page.RelPermalink $.RelPermalink }}
                <li>
                  <a href="{{ $page.RelPermalink }}"
                    class="flex items-center gap-2.5 px-3 py-2 rounded-lg text-sm transition-all group {{ if $isCurrent }}bg-primary/15 text-primary font-medium shadow-sm{{ else }}text-muted-foreground hover:text-foreground hover:bg-muted/50{{ end }}"
                    {{ if $isCurrent }}aria-current="page" {{ end }}>
                    <span
                      class="font-mono text-xs flex-shrink-0 {{ if $isCurrent }}text-primary{{ else }}opacity-50 group-hover:opacity-100{{ end }} transition-opacity">
                      {{ printf "%02d" (add $index 1) }}
                    </span>
                    <span class="flex-1 truncate">{{ $page.LinkTitle }}</span>
                    {{- if $isCurrent }}
                    <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd" />
                    </svg>
                    {{- end }}
                  </a>
                </li>
                {{- end }}
              </ol>
            </nav>
            {{- end }}
          </div>

          <script>
            function switchSeries(index) {
              // 1. 更新 Tabs 样式
              document.querySelectorAll('.series-tab-btn').forEach(btn => {
                const isTarget = parseInt(btn.dataset.index) === index;
                if (isTarget) {
                  btn.classList.add('bg-accent', 'text-foreground', 'border-border', 'shadow-sm');
                  btn.classList.remove('hover:bg-accent/50', 'text-muted-foreground');
                } else {
                  btn.classList.remove('bg-accent', 'text-foreground', 'border-border', 'shadow-sm');
                  btn.classList.add('hover:bg-accent/50', 'text-muted-foreground');
                }
              });

              // 2. 切换内容显示
              document.querySelectorAll('.series-content').forEach(content => {
                content.classList.add('hidden', 'opacity-0', 'z-0');
                content.classList.remove('block', 'opacity-100', 'z-10');
              });

              const targetContent = document.getElementById(`series-content-${index}`);
              if (targetContent) {
                targetContent.classList.remove('hidden', 'opacity-0', 'z-0');
                targetContent.classList.add('block', 'opacity-100', 'z-10');

                // 3. 更新跳转链接
                const linkBtn = document.getElementById('series-link-btn');
                if (linkBtn) {
                  linkBtn.href = targetContent.dataset.link;
                }
              }
            }

            // 初始化链接
            document.addEventListener('DOMContentLoaded', () => {
              const activeContent = document.querySelector('.series-content.block');
              if (activeContent) {
                const linkBtn = document.getElementById('series-link-btn');
                if (linkBtn) linkBtn.href = activeContent.dataset.link;
              }
            });
          </script>
        </div>
      </div>
      {{- else }}
    </div>
    {{- end }}
  </div>
</div>
