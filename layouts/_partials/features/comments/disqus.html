{{/* Disqus comments - custom override for legacy identifier support */}}

{{ $id := .id | default "disqus-comments" }}
{{ $config := .Site.Params.comments.disqus }}
{{ $page := .Page }}

{{ if $config.shortname }}
  <div id="{{ $id }}" class="disqus-container">
    <div id="disqus_thread"></div>

    <script>
      (function() {
        'use strict';

        var disqus_config = function () {
          this.page.url = '{{ $page.Permalink }}';

          // Use disqus_identifier from front matter if available (for migrated posts)
          // Otherwise fall back to RelPermalink
          {{ if $page.Params.disqus_identifier }}
          this.page.identifier = '{{ $page.Params.disqus_identifier }}';
          {{ else if $page.Params.aliases }}
          // For WordPress-migrated posts, use the old permalink as identifier
          this.page.identifier = '{{ index $page.Params.aliases 0 }}';
          {{ else }}
          this.page.identifier = '{{ $page.RelPermalink }}';
          {{ end }}

          this.page.title = '{{ $page.Title | safeJS }}';
        };

        function loadDisqus() {
          var d = document, s = d.createElement('script');
          s.src = 'https://{{ $config.shortname }}.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', loadDisqus);
        } else {
          loadDisqus();
        }
      })();
    </script>

    <noscript>
      Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
    </noscript>
  </div>
{{ end }}
