{{/* Disqus comments - custom override for legacy identifier support */}}

{{ $id := .id | default "disqus-comments" }}
{{ $config := .Site.Params.comments.disqus }}
{{ $page := .Page }}

{{ if $config.shortname }}
  <div id="{{ $id }}" class="disqus-container">
    <div id="disqus_thread"></div>

    <script>
      (function() {
        'use strict';

        // Detect if dark mode is active
        function isDarkMode() {
          return document.documentElement.classList.contains('dark');
        }

        var disqus_config = function () {
          this.page.url = '{{ $page.Permalink }}';

          // Use disqus_identifier from front matter if available (for migrated posts)
          // Otherwise fall back to RelPermalink
          {{ if $page.Params.disqus_identifier }}
          this.page.identifier = '{{ $page.Params.disqus_identifier }}';
          {{ else if $page.Params.aliases }}
          // For WordPress-migrated posts, use the old permalink as identifier
          this.page.identifier = '{{ index $page.Params.aliases 0 }}';
          {{ else }}
          this.page.identifier = '{{ $page.RelPermalink }}';
          {{ end }}

          this.page.title = '{{ $page.Title | safeJS }}';
        };

        function loadDisqus() {
          var d = document, s = d.createElement('script');
          s.src = 'https://{{ $config.shortname }}.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        }

        function reloadDisqus() {
          if (typeof DISQUS !== 'undefined') {
            DISQUS.reset({
              reload: true,
              config: disqus_config
            });
          }
        }

        // Listen for theme changes and reload Disqus
        window.addEventListener('themeChanged', reloadDisqus);

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', loadDisqus);
        } else {
          loadDisqus();
        }
      })();
    </script>

    <style>
      /* Force Disqus iframe to use dark background when in dark mode */
      .dark #disqus_thread {
        color-scheme: dark;
      }
      #disqus_thread {
        padding: 1rem;
        border-radius: 0.5rem;
      }
    </style>

    <noscript>
      Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
    </noscript>
  </div>
{{ end }}
